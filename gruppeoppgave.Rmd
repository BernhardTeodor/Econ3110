---
title: "Gruppeoppgave"
author: "Kandidatnummer??"
date: "HÃ¸st 2025"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = T)
```


## Laste inn data

```{r}

library(haven) # Lese inn data sett
library(dplyr) # Databehandling
library(fixest) # Regresjon

df <- read_dta("data/Combined_allwaves_final.dta") # Leser data 

df <- df |> 
  mutate(miss_age_PAP = ifelse(is.na(age_med_BL), 1, 0)) |> 
  mutate(age_med_BL_control= ifelse(is.na(age_med_BL), 0, 1))|> 
  mutate(miss_household_size= ifelse(is.na(household_size), 1, 0))|> 
  mutate(household_size_control= ifelse(is.na(household_size), 0, household_size)) |> 
  mutate(miss_edu_category= ifelse(is.na(edu_nohs_BL), 1, 0))|> 
  mutate(edu_nohs_BL_control= ifelse(is.na(edu_nohs_BL), 0, edu_nohs_BL))|> 
  mutate(married_control= ifelse(is.na(married), 0, married))|> 
  mutate(divorced_separated_control= ifelse(is.na(divorced_separated), 0,
  divorced_separated))|> 
  mutate(single_control= ifelse(is.na(single), 0, single))|> 
  mutate(widowed_control= ifelse(is.na(widowed), 0, widowed))|> 
  mutate(miss_relationship= ifelse(is.na(rel_status_BL), 1, 0))|> 
  mutate(miss_cars= ifelse(is.na(cars), 1, 0))|> 
  mutate(one_car_control= ifelse(is.na(one_car), 0, one_car))|> 
  mutate(mult_cars_control= ifelse(is.na(mult_cars), 0, mult_cars))|> 
  mutate(miss_LF_BL= ifelse(is.na(LF_BL), 1, 0))|> 
  mutate(LF_BL_control= ifelse(is.na(LF_BL), 0, LF_BL)) |> 
  filter(endline_start_w3==1)
```


```{r}
s_train <- feols(s_train_bi_w3~ treatment + age_med_BL_control + miss_age_PAP + edu_nohs_BL_control
      + miss_edu_category + married_control + single_control + widowed_control
      + miss_relationship + household_size_control + miss_household_size + one_car_control
      + miss_cars + LF_BL_control + miss_LF_BL |randomization_cohort2, cluster = c("file_nbr"), data = df)


licence <- feols(license_w3~ treatment + age_med_BL_control + miss_age_PAP + edu_nohs_BL_control
      + miss_edu_category + married_control + single_control + widowed_control
      + miss_relationship + household_size_control + miss_household_size + one_car_control
      + miss_cars + LF_BL_control + miss_LF_BL |randomization_cohort2, cluster = c("file_nbr"), data = df)



empl <- feols(employed_w3~ treatment +age_med_BL_control + miss_age_PAP + edu_nohs_BL_control
      + miss_edu_category + married_control + single_control + widowed_control
      + miss_relationship + household_size_control + miss_household_size + one_car_control
      + miss_cars + LF_BL_control + miss_LF_BL |randomization_cohort2, cluster = c("file_nbr"), data = df)


not_empl <- feols(unemployed_w3~  treatment + age_med_BL_control + miss_age_PAP + edu_nohs_BL_control
      + miss_edu_category + married_control + single_control + widowed_control
      + miss_relationship + household_size_control + miss_household_size + one_car_control
      + miss_cars + LF_BL_control + miss_LF_BL |randomization_cohort2, cluster = c("file_nbr"), data = df)

```


```{r}

controls <- c("miss_age_PAP","age_med_BL_control", "miss_edu_category", "married_control",
              "widowed_control","miss_relationship", "household_size_control", "miss_household_size",
              "one_car_control", "mult_cars_control", "miss_cars","LF_BL_control", "LF_BL_control",
              "edu_nohs_BL_control", "single_control", "miss_LF_BL", "Constant", "randomization_cohort2")


tit <- "Treatment Effects on Individual Outcomes and Intrahousehold Responses"



fitstat_register("control_mean", function(x) mean(x), "Control mean")

fitstat_register("mean", function(x) mean(x, na.rm = T), "control_m")

fitstat_register("pval", function(x) pvalue(x), "p-value b = 0")

fitstat_register("mean_c", 

                 function(x){
                   name <- x$fml[2] |> as.character()
                   xer <- df |> 
                   filter(treatment == 0) |> 
                   select(name) |> pull()
                   mean(xer,na.rm = T)
                   }, 
                 "Control mean"
)


fitstat_register("me", 

                 function(x){
                   name <- x$fml[2] |> as.character()
                   xer <- df |> 
                   filter(treatment == 0) |> 
                   select(name) |> pull()
                   
                   x$coefficients[1]/ mean(xer,na.rm = T)
                   }, 
                 "b/Control mean"
)

```




```{r,warning=FALSE}

etable(s_train,licence,
       se.below=T, 
       drop = controls, 
       title =tit, 
       digits = "r3",digits.stats = "r3",
       tex = T, 
       signif.code = NA,
       dict=c(treatment = "Treatment", 
              s_train_bi_w3 = "Started driver`s training", 
              license_w3 = "Received license", 
              randomization_cohort2 = ""),
       style.tex = style.tex("qje", ),
       fitstat = ~ n + mean_c +me + pval)

```





```{r}
etable(empl,not_empl ,
       se.below=T, 
       drop = controls, 
       title =tit,
       digits = "r3",digits.stats = "r3",
       tex = T, 
       signif.code = NA,
       dict=c(treatment = "Treatment", 
              employed_w3 = "Employed", 
              unemployed_w3 = "Unemployed", 
              randomization_cohort2 = ""),
       style.tex = style.tex("qje", ),
       fitstat = ~ n + mean_c +me + pval)
```






```{r}
etable(empl,
       se.below=T,tex = T)


```







